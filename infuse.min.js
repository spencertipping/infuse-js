(function(){var a=typeof infuse!=typeof void 0?infuse:undefined,b=function(a){var b=function(c){for(var d=b.alternatives,e=d.length-1,f;e>=0;--e)if((f=d[e]).accepts.apply(f,arguments))return f.construct.apply(f,arguments);throw new Error(a+"("+Array.prototype.slice.call(arguments).join(", ")+") is not supported (no alternative accepted the supplied "+"arguments)")};return b.alternatives=[],b},c=b("infuse");c.dispatcher=b,c.hide=function(){return infuse=a,a=null,delete c.hide,c},c.unloaders=[],c.unload=function(){for(var a=c.unloaders,b=0,d=a.length;b<d;++b)a[b]()},infuse=c})(),function(a){a.extend=function(b){return b.call(a,a,a.prototype)||a}}(infuse),infuse.extend(function(a){var b={};a.alternatives.push({accepts:function(a){return a===b},construct:function(){}}),a.type=function(c,d){var e=a[c]=function(){if(this.constructor!==e){var a=new e;return a.initialize.apply(a,arguments),a}};return(e.prototype=new a(b)).constructor=e,d.call(e,e,e.prototype)||e},a.mixins={},a.mixin=function(b,c){var d={};return c.call(d,d),a.mixins[b]=function(a){for(var b in d)Object.prototype.hasOwnProperty.call(d,b)&&(a[b]=d[b]);return a}}}),infuse.extend(function(a){a.mixin("pull",function(b){b.base=function(){return this.base_},b.version=function(){return this.version_},b.pull=function(){var a=this.base_,b=a&&a.pull().version();if(b&&b>this.version_){++this.version_;var c=this;this.generator_(function(a,b){c.push_(a,b)},this.id()),this.version_=b}return this},b.push=function(b,c){return a.assert(!this.base_,"infuse: attempted to push onto a derivative"),++this.version_,this.push_(b,c)},b.detach=function(){return this.base_&&this.base_.detach_derivative(this),this.base_=this.generator_=null,this},b.detach_derivative=function(a){return this}})}),infuse.extend(function(a){a.mixin("push",function(a){a.pull=function(){return this},a.version=function(){return this.size()+1},a.detach=function(a){if(a)a.detach_derivative(this),delete this.bases_[a.id()];else{var b=this.bases_;for(var c in b)Object.prototype.hasOwnProperty.call(b,c)&&(b[c].detach_derivative(this),delete b[c])}return this},a.detach_derivative=function(a){var b=this.listeners_;return b&&delete b[a.id()],this}})}),infuse.extend(function(a){var b=0;a.gen_id=function(){return"infuse-"+ ++b},a.toa=function(a){return Array.prototype.slice.call(a)},a.slice=function(a,b){return Array.prototype.slice.call(a,b)},a.fnarg=function(b,c){return a.fn.apply(this,a.slice(b,c))},a.assert=function(a,b){if(!a)throw new Error(b);return a},a.assert_equal=function(b,c){return a.assert(b===c,b+" != "+c),b},a.msb=function(a){for(var b=0,c=64;b+1<c;){var d=b+c>>>1,e=a>>>d;e&&e!==a?b=d:c=d}return b}}),infuse.extend(function(a){a.type("heapmap",function(b,c){a.mixins.pull(c),c.initialize=function(b,c,d){this.above_=b?a.fn.apply(this,arguments):function(a,b){return a<=b},this.xs_=[null],this.keys_=[null],this.map_={},this.base_=d,this.generator_=c,a.assert(!!d==!!c,"infuse: base and generator must be specified together (error constructing heapmap)")},c.size=function(){return this.pull().xs_.length-1},c.derivative=function(b){var c=a.fn.apply(this,arguments);return a.heapmap(this.above_,c,this)},c.generator=function(){var b=this,c=null,d=!1;return function(e){var f=b.xs_,g=b.keys_,h=f.length;if(h<=1)return;d||(c=f[1],d=!0);var i=a.msb(h-1),j=b.initial_ceiling_(c,i);if(j===null)return;var k=a.heapmap(b.above_),l=b.version_;for(var m=b.initial_ceiling_(c,i),n;m!==null;c=n,m=b.next_ceiling_(c,m,i))k.push(n=f[m],m);while(k.size()){var m=+k.pop();if(e(c=f[m],g[m])===!1)return;var o=m<<1;if(o<h){k.push(f[o],o);var p=o+1;p<h&&k.push(f[p],p)}}}},c.next_ceiling_=function(b,c,d){if((c&c+1)===0)return null;var e=this.xs_,f=e.length;if(c+1>=f)return null;var g=c&1;c++;if(this.above_(b,e[c]))return g?this.topmost_ceiling_(b,c,d):c;for(c<<=d-a.msb(c);c<f;++c)if(this.above_(b,e[c]))return this.topmost_ceiling_(b,c,d);return null},c.topmost_ceiling_=function(a,b,c){var d=this.xs_;for(var e=0,f=c;e+1<f;){var g=e+f>>>1;this.above_(a,d[b>>>g])?e=g:f=g}return b>>>e+1},c.initial_ceiling_=function(a,b){var c=this.xs_;for(var d=1<<b,e=c.length;d<e;++d)if(this.above_(a,c[d]))return this.topmost_ceiling_(a,d,b);return null},c.get=function(b){var c=this.map_;return Object.prototype.hasOwnProperty.call(c,b)?this.xs_[c[b]]:a.fn.apply(this,arguments)(this,this.id())},c.remove=function(b){a.assert(!this.base_,"infuse: attempted to remove() from a derivative heapmap (because the heap map is a derivative, modifying it directly is illegal)");var c=this.xs_,d=this.map_,e=this.keys_;return c.length<=1?void 0:(c.length>2?(c[1]=c.pop(),e[1]=e.pop()):(c.pop(),e.pop()),c.length>1&&(d[e[1]]=1,this.heapify_down_(1)),delete d[b],++this.version_,this)},c.pop=function(){var a=this.keys_;if(a.length<=1)return void 0;var b=a[1];return this.remove(b),b},c.peek=function(){return this.keys_[1]},c.push_=function(a,b){var c=this.xs_,d=this.keys_,e=this.map_;if(Object.prototype.hasOwnProperty.call(e,b)){var f=e[b],g=c[f];return c[f]=a,this.above_(a,g)?this.heapify_up_(f):this.heapify_down_(f)}var h=c.length;return c.push(a),d.push(b),this.heapify_up_(e[b]=h)},c.swap_=function(a,b){var c=this.xs_,d=this.keys_,e=this.map_,f=c[a];return c[a]=c[b],c[b]=f,f=d[a],d[a]=d[b],d[b]=f,e[d[a]]=a,e[d[b]]=b,this},c.heapify_down_=function(a){var b=this.xs_,c=b.length;if(a<<1>=c)return this;var d=a<<1,e=d|1,f=b[a],g=b[d],h=b[e];if(this.above_(f,g)&&(e>=c||this.above_(f,h)))return this;var i=e>=c||this.above_(g,h)?d:e;return this.swap_(a,i).heapify_down_(i)},c.heapify_up_=function(a){var b=this.xs_,c=a>>>1;return c&&this.above_(b[a],b[c])?this.swap_(a,c).heapify_up_(c):this}})}),infuse.extend(function(a){a.cache=function(b){var c={},d={};b=b||a.cache.lru();var e=function(a,f){return b(e,c,d,a,f)};return e(null,null),e},a.cache.lru=function(b){b=b||{};var c=b.capacity||1e3,d=function(a,b){return b.size?(--b.size,delete a[b.priority_queue.pop()]):!1},e=function(a,b){for(var c in a)delete a[c];while(b.priority_queue.size())b.priority_queue.pop();b.size=0};return function(b,f,g,h,i){if(h===null&&i===null)return g.size=0,g.access_counter=0,g.priority_queue=a.heapmap(),b.hits=0,b.evictions=0,b.misses=0,b.evict_one=function(){return d(f,g)},b.clear=function(){return e(f,g)},null;h="@"+h;var j=f[h];if(j)return++b.hits,g.priority_queue.push(++g.access_counter,h),j;var k=i(h);return++b.misses,++g.size>c&&(++b.evictions,d(f,g)),g.priority_queue.push(++g.access_counter,h),f[h]=k}}}),infuse.extend(function(a){a.fn=a.dispatcher("infuse.fn"),a.fn.cache=a.cache(a.cache.lru({capacity:2048})),a.fn.auto_gc=function(){a.fn.cache_interval=setInterval(a.fn.cache.evict_one,1e3),a.unloaders.push(function(){clearInterval(a.fn.cache_interval)})},a.fn.alternatives.push({accepts:function(a){return a.constructor===RegExp},construct:function(b){return a.fn.regexp_group_count(b)?function(a){var c=b.exec(a);return c&&Array.prototype.slice.call(c,1)}:function(a){var c=b.exec(a);return c&&c[0]}}}),a.fn.regexp_group_count=function(a){for(var b=a.toString(),c=0,d=-1,e=b.lastIndexOf("/"),f=!1,g=1,h=!1,i;g<e;++g)i=b.charCodeAt(g),f?f=!1:i===92?f=!0:i===93?h=!1:h||(i===91?h=!0:i===40?(d=g+1,++c):g===d&&i===63&&--c);return c},a.fn.is_path=function(a){return/^\./.test(a)},a.fn.is_js=function(a){return/^[-+\/~!$\w([{'"]/.test(a)},a.fn.alternatives.push({accepts:function(b){return b.constructor===String&&a.fn.is_path(b)},construct:function(b){return a.fn.cache(b,function(){var c=a.inversion.parse_path(b);return function(b){return a.inversion.at(c,b)}})}}),a.fn.alternatives.push({accepts:function(b){return b.constructor===String&&a.fn.is_js(b)},construct:function(b,c){return a.fn.cache(a.fn.binding_prefix(c)+b,function(){return a.fn.compile(b,c)})(c)}}),a.fn.binding_prefix=function(a){if(!a)return"";var a=[];for(var b in a)Object.prototype.hasOwnProperty.call(a,b)&&a.push(b);return a.sort().join(",")+":"},a.fn.body_arity=function(a){for(var b=a.match(/_\d?/g)||[],c=0,d=b.length,e=+!!b.length;c<d;++c)e=Math.max(e,+b[c].substr(1));return e},a.fn.compile=function(b,c){var d=[],e=[];for(var f in c)Object.prototype.hasOwnProperty.call(c,f)&&d.push("var "+f+" = _."+f+";\n");for(var g=0,h=a.fn.body_arity(b);g<h;++g)e.push("_"+(g+1));return new Function("_",d+"return function ("+e.join(", ")+") {\n"+(e.length?"var _ = _1;\n":"")+"return "+b+";\n"+"};")},a.fn.alternatives.push({accepts:function(a){return a instanceof Function},construct:function(a){return a}})}),infuse.extend(function(a){a.type("array",function(b,c){a.mixins.pull(c),c.initialize=function(b,c){b instanceof Function?(this.xs_=[],this.base_=c,this.generator_=b,this.version_=-1,this.pull()):(this.xs_=b instanceof Array?b:a.toa(b),this.base_=null,this.generator_=null,this.version_=1)},c.size=function(){return this.pull().xs_.length},c.push_=function(a,b){return this.xs_.push(a),this},c.derivative=function(b){var c=a.fn.apply(this,arguments);return a.array(c,this)},c.generator=function(){var a=0,b=this;return function(c){for(var d=b.pull().xs_,e=d.length;a<e;)if(c(d[a],a++)===!1)return!1}},c.get=function(b,c){var d=this.pull().xs_;if(b===void 0)return d;if(typeof b=="number"||b instanceof Number){if(b===b>>0)return d[b<0?d.length+b:b];var e=arguments.length>1?a.fnarg(arguments,1):function(a,b,c){return a+(b-a)*c},f=(b<0?d.length:0)+Math.floor(b),g=f+1,h=b-f;return e(d[f],d[g],h)}if(b instanceof Array){for(var i=[],j=0,k=b.length;j<k;++j)i.push(this.get(b[j]));return i}return a.fn.apply(this,arguments)(this,this.id())},c.first=function(b){var c=this.get();if(b===void 0)return c[0];if(typeof b=="number"||b instanceof Number)return a.array(c.slice(0,b<0?c.length+b:b));var d=a.fn.apply(this,arguments);for(var e=0,f=c.length;e<f;++e)if(d(c[e],e))return c[e];return null},c.last=function(b){var c=this.get(),d=c.length;if(b===void 0)return c[d-1];if(typeof b=="number"||b instanceof Number)return a.array(b===0?c:c.slice(b<0?d+b:b));var e=a.fn.apply(this,arguments);for(var f=d-1;f>=0;++f)if(e(c[f],f))return c[f];return null}}),a.alternatives.push({accepts:function(a){return a instanceof Array},construct:function(b){return a.array(b)}})}),infuse.extend(function(a){a.type("object",function(b,c){a.mixins.pull(c),c.initialize=function(b,c){b instanceof Function?(this.o_={},this.base_=a.assert(c,"infuse: attempted to construct a derivative object without specifying a base"),this.generator_=b,this.version_=-1,this.journal_=a.heapmap(),this.pull()):(this.o_=b,this.base_=null,this.generator_=null,this.version_=1,this.journal_=null)},c.size=function(){return this.pull().journal().size()},c.push_=function(a,b){var c=this.o_;return c[b]=a,this.journal().push(this.version_,b),this},c.derivative=function(b){var c=a.fn.apply(this,arguments);return a.object(c,this)},c.journal=function(){var b=this.journal_;if(!b){var c=this.o_,d=this.version_;b=this.journal_=a.heapmap();for(var e in c)Object.prototype.hasOwnProperty.call(c,e)&&b.push(d,e)}return b},c.generator=function(){var a=this.journal().generator(),b=this.o_;return function(c){return a(function(a,d){return c(b[d],d)})}},c.get=function(b){var c=this.pull().o_;if(b===void 0)return c;if((typeof b=="string"||b instanceof String)&&Object.prototype.hasOwnProperty.call(c,b))return c[b];if(b instanceof Array){for(var d=[],e=0,f=b.length;e<f;++e)d.push(this.get(b[e]));return d}return a.fn.apply(this,arguments)(this,this.id())}});var b=Object.prototype.toString.call({});a.alternatives.push({accepts:function(a){return Object.prototype.toString.call(a)===b},construct:function(b){return a.object(b)}})}),infuse.extend(function(a){a.type("multiobject",function(b,c){a.mixins.pull(c),c.initialize=function(b,c){this.o_={},this.size_=0,this.journal_=a.heapmap();if(b instanceof Function)this.version_=-1,this.generator_=b,this.base_=a.assert(c,"infuse: attempted to create a derivative multiobject without specifying a base"),this.pull();else{this.version_=0,this.generator_=null,this.base_=null;if(b)for(var d in b)Object.prototype.hasOwnProperty.call(b,d)&&this.push(b[d],d)}},c.size=function(){return this.pull().size_},c.push_=function(a,b){var c=this.o_;return Object.prototype.hasOwnProperty.call(c,b)?c[b].push(a):c[b]=[a],this.journal().push(this.version_,b),++this.size_,this},c.derivative=function(b){var c=a.fn.apply(this,arguments);return a.multiobject(c,this)},c.generator=function(){var a=this.journal().generator(),b=this.o_;return function(c){return a(function(a,d){for(var e=0,f=b[d],g=a.length;e<g;++e)if(c(f[e],d)===!1)return!1})}},c.get=function(b){var c=this.pull().o_;if(b===void 0)return c;if((typeof b=="string"||b instanceof String)&&Object.prototype.hasOwnProperty.call(c,b))return c[b];if(b instanceof Array){for(var d=[],e=0,f=b.length;e<f;++e)d.push(this.get(b[e]));return d}return a.fn.apply(this,arguments)(this,this.id())}})}),infuse.extend(function(a){a.type("future",function(b,c){a.mixins.push(c),c.initialize=function(b,c){this.listeners_={},this.bases_={},this.value_=null,this.key_=null,this.generator_=null;if(b){a.assert(c,"infuse: attempted to construct a derivative future without specifying a base");var d=this;b(function(a,b){return d.push(a,b)},this.id()),this.bases_[c.id()]=c}},c.size=function(){return+!this.listeners_},c.key=function(){return this.key_},c.value=function(){return this.value_},c.derivative=function(b){var c=a.fn.apply(this,arguments);return a.future(c,this)},c.generator=function(){var a=this.generator_;if(!a){var b=this;a=this.generator_=function(a,c){var d=b.listeners_;if(!d)return a(b.value_,b.key_);c!=null&&(d[c]=a)}}return a},c.push=function(b,c){a.assert(this.listeners_,"infuse: attempted to push to an already-decided future");var d=this.listeners_;for(var e in d)Object.prototype.hasOwnProperty.call(d,e)&&d[e](b,c);return this.listeners_=null,this.value_=b,this.key_=c,this},c.get=function(a){if(a===void 0){if(this.listeners_)return{};var b={};return b[this.key_]=this.value_,b}return a===this.key_?this.value_:null},c.on=function(b,c){var d=typeof b=="string"||b instanceof String?function(a){return a===b}:a.fn(b);return this.generator()(function(a,b){d(b)&&c(a,b)},a.gen_id()),this},c.once=c.on,c.trigger=function(a){var b=this;return function(c){b.push(c,a)}}})}),infuse.extend(function(a){a.type("signal",function(b,c){a.mixins.push(c),c.initialize=function(b,c){this.listeners_={},this.bases_={},this.value_=null,this.key_=null,this.generator_=null,this.size_=0;if(b){a.assert(c,"infuse: attempted to construct a derivative signal without specifying a base");var d=this;b(function(a,b){return d.push(a,b)},this.id()),this.bases_[c.id()]=c}},c.size=function(){return this.size_},c.key=function(){return this.key_},c.value=function(){return this.value_},c.derivative=function(b){var c=a.fn.apply(this,arguments);return a.signal(c,this)},c.generator=function(){var b=this.generator_;if(!b){var c=this;b=this.generator_=function(b,d){a.assert(d!=null,"infuse: attempted to construct a push generator without specifying an ID (this may cause space leaks, so it is disallowed)"),c.listeners_[d]=b}}return b},c.push=function(a,b){var c=this.listeners_;for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&c[d](a,b);return this.value_=a,this.key_=b,++this.size_,this},c.get=function(a){if(a===void 0){var b={};return this.key_!=null&&(b[this.key_]=this.value_),b}return a===this.key_?this.value_:null},c.on=function(b,c){var d=typeof b=="string"||b instanceof String?function(a){return a===b}:a.fn(b);return this.generator()(function(a,b){d(b)&&c(a,b)},a.gen_id()),this},c.once=function(b,c){var d=typeof b=="string"||b instanceof String?function(a){return a===b}:a.fn(b),e=a.gen_id(),f=this;return this.generator()(function(a,b){d(b)&&(delete f.listeners_[e],c(a,b))},e),this},c.trigger=function(a){var b=this;return function(c){b.push(c,a)}}})}),infuse.extend(function(a,b){b.id=function(){var b=this.id_;return b||(b=this.id_=a.gen_id()),b},b.keys=function(){var b=this.generator();return a.array(function(a,c){b(function(b,c){return a(c,c)},c)},this)},b.values=function(){var b=this.generator();return a.array(b,this)},b.each=function(b){var c=a.fn.apply(this,arguments);return this.generator()(c),this},b.map=function(b){var c=a.fn.apply(this,arguments),d=this.generator();return this.derivative(function(a,b){d(function(b,d){return a(c(b,d),d)},b)})},b.flatmap=function(b){var c=a.fn.apply(this,arguments),d=this.generator();return this.derivative(function(b,e){d(function(d,e){var g=c(d,e);return g&&a(c(d,e)).each(b)},e)})},b.filter=function(b){var c=a.fn.apply(this,arguments),d=this.generator();return this.derivative(function(a,b){d(function(b,d){if(c(b,d))return a(b,d)},b)})},b.mapfilter=function(b){var c=a.fn.apply(this,arguments),d=this.generator();return this.derivative(function(a,b){d(function(b,d){var e=c(b,d);if(e)return a(e,d)},b)})},b.reductions=function(b,c){var d=a.fnarg(arguments,1),e=this.generator();return this.derivative(function(a,c){e(function(c,e){return a(b=d(b,c,e),e)},c)})},b.reduce=function(b,c){var d=a.fnarg(arguments,1);return this.each(function(a,c){b=d(b,a,c)}),b},b.index=function(b){var c=a.fn.apply(this,arguments),d=this.generator();return a.object(function(a,b){d(function(b,d){return a(b,c(b,d))},b)},this)},b.group=function(b){var c=a.fn.apply(this,arguments),d=this.generator();return a.multiobject(function(a,b){d(function(b,d){return a(b,c(b,d))},b)},this)}});