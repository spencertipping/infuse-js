(function(){var a=typeof infuse!=typeof void 0?infuse:undefined,b=function(a){var b=function(c){for(var d=b.alternatives,e=d.length-1,f;e>=0;--e)if((f=d[e]).accepts.apply(f,arguments))return f.construct.apply(f,arguments);throw new Error(a+"("+Array.prototype.slice.call(arguments).join(", ")+") is not supported (no alternative accepted the supplied "+"arguments)")};return b.alternatives=[],b},c=b("infuse");c.dispatcher=b,c.hide=function(){return infuse=a,a=null,delete c.hide,c},c.unloaders=[],c.unload=function(){for(var a=c.unloaders,b=0,d=a.length;b<d;++b)a[b]()},infuse=c})(),infuse.extend=function(a){return a.call(infuse,infuse,infuse.prototype)||infuse},infuse.extend(function(a){var b={};a.alternatives.push({accepts:function(a){return a===b},construct:function(){}}),a.type=function(c,d){var e=a[c]=function(){if(this.constructor!==e){var a=new e;return a.initialize.apply(a,arguments),a}};return(e.prototype=new a(b)).constructor=e,d.call(e,e,e.prototype)||e}}),infuse.extend(function(a){a.toa=function(a){return Array.prototype.slice.call(a)},a.slice=function(a,b){return Array.prototype.slice.call(a,b)},a.fnarg=function(b,c){return a.fn.apply(this,a.slice(b,c))},a.assert=function(a,b){if(!a)throw new Error(b);return a},a.assert_equal=function(b,c,d){return a.assert(b===c,d),b}}),infuse.extend(function(a){a.type("heapmap",function(b,c){c.initialize=function(a,b,c){this.ordering_=a||function(a,b){return a<b},this.elements_=[],this.positions_={},this.base_=c||null,this.generator_=b||function(a){throw new Error("infuse: attempted to generate new elements for a heap map with no specified generator")},this.versions_={},this.version_=0},c.size=function(){return this.elements_.length},c.derivative=function(b){return a.heapmap(ordering,b,this)},c.force=function(a){},c.touch=function(a){},c.each=function(){var b=a.fn.apply(this,arguments);for(var c=this.elements_,d=0,e=c.length;d<e;++d)if(b(c[d].k,d)===!1)break;return this},c.get=function(b){var c=this.positions_;return Object.prototype.hasOwnProperty.call(c,b)?this.elements_[c[b]].v:a.fn.apply(this,arguments)(this)},c.pop=function(){var a=this.elements_,b=this.positions_;if(!a.length)return void 0;this.touch();var c=a[0];return a[0]=xs_.pop(),this.heapify_down_(0),b[a[0].k]=0,delete b[c.k],c.k},c.push=function(a,b){var c=this.elements_,d=this.positions_;this.touch();if(Object.prototype.hasOwnProperty.call(d,a)){var e=d[a],f=c[e],g=f.v;return f.v=b,this.ordering(b,g)?this.heapify_up_(e):this.heapify_down_(e)}var h=c.length;return c.push({k:a,v:b}),d[a]=h,this.heapify_up_(h)},c.swap_=function(a,b){var c=this.elements_,d=this.positions_,e=c[a];return c[a]=c[b],c[b]=e,d[c[a].k]=a,d[c[b].k]=b,this},c.heapify_down_=function(a){var b=this.elements_;if(a<<1>=b.length)return this;var c=a<<1,d=a<<1|1,e=b[a].v,f=b[c].v,g=b[d].v;if(this.ordering(e,f)&&this.ordering(e,g))return this;var h=this.ordering(f,g)?f:g;return this.swap_(a,h).heapify_down_(h)},c.heapify_up_=function(a){var b=this.elements_,c=a>>>1;return a&&this.ordering(b[a],b[c])?this.swap_(a,c).heapify_up_(c):this}})}),infuse.extend(function(a){a.cache=function(b){var c={},d={};b=b||a.cache.lru();var e=function(a,f){return b(e,c,d,a,f)};return e(null,null),e},a.cache.lru=function(b){b=b||{};var c=b.capacity||1e3,d=function(a,b){return b.size?(--b.size,delete a[b.priority_queue.pop()]):!1},e=function(a,b){for(var c in a)delete a[c];while(b.priority_queue.size())b.priority_queue.pop();b.size=0};return function(b,f,g,h,i){if(h===null&&i===null)return g.size=0,g.access_counter=0,g.priority_queue=a.heapmap(),b.hits=0,b.evictions=0,b.misses=0,b.evict_one=function(){return d(f,g)},b.clear=function(){return e(f,g)},null;h="@"+h;var j=f[h];if(j)return++b.hits,g.priority_queue.update(h,++g.access_counter),j;var k=i(h);return++b.misses,++g.size>c&&(++b.evictions,d(f,g)),g.priority_queue.push(h,++g.access_counter),f[h]=k}}}),infuse.extend(function(a){a.fn=a.dispatcher("infuse.fn"),a.fn.cache=a.cache(a.cache.lru({capacity:2048})),a.fn.cache_interval=setInterval(a.fn.cache.evict_one,1e3),a.unloaders.push(function(){clearInterval(a.fn.cache_interval)}),a.fn.alternatives.push({accepts:function(a){return a.constructor===RegExp},construct:function(b){return a.fn.regexp_group_count(b)?function(a){var c=b.exec(a);return c&&Array.prototype.slice.call(c,1).join("")}:function(a){return b.exec(a)}}}),a.fn.regexp_group_count=function(a){for(var b=a.toString(),c=0,d=-1,e=b.lastIndexOf("/"),f=!1,g=1,h=!1,i;g<e;++g)i=b.charCodeAt(g),f?f=!1:i===92?f=!0:i===93?h=!1:h||(i===91?h=!0:i===40?(d=g+1,++c):g===d&&i===63&&--c);return c},a.fn.is_path=function(a){return/^[\.\[]/.test(a)},a.fn.is_js=function(a){return/^[-+\/~!$\w([{'"]/.test(a)},a.fn.alternatives.push({accepts:function(b){return b.constructor===String&&a.fn.is_path(b)},construct:function(b){return a.fn.cache(b,function(){var c=a.inversion.parse_path(b);return function(b){return a.inversion.at(c,b)}})}}),a.fn.alternatives.push({accepts:function(b){return b.constructor===String&&a.fn.is_js(b)},construct:function(b,c){return a.fn.cache(a.fn.binding_prefix(c)+b,function(){return a.fn.compile(b,c)})(c)}}),a.fn.binding_prefix=function(a){if(!a)return"";var a=[];for(var b in a)Object.prototype.hasOwnProperty.call(a,b)&&a.push(b);return a.sort().join(",")+":"},a.fn.body_arity=function(a){for(var b=a.match(/_\d?/g),c=0,d=b.length,e=+!!b.length;c<d;++c)e=Math.max(e,+b[c].substr(1));return e},a.fn.compile=function(b,c){var d=[],e=[];for(var f in c)Object.prototype.hasOwnProperty.call(c,f)&&d.push("var "+f+" = _."+f+";\n");for(var g=0,h=a.fn.body_arity(b);g<h;++g)e.push("_"+(g+1));return new Function("_",d+"return function ("+e.join(", ")+") {\n"+(e.length?"var _ = _1;\n":"")+"return "+b+";\n"+"};")},a.fn.alternatives.push({accepts:function(a){return a instanceof Function},construct:function(a){return a}})}),infuse.extend(function(a){a.type("array",function(b,c){c.initialize=function(b,c){b instanceof Function?(this.xs_=[],this.base_=c,this.generator_=b):(this.xs_=b instanceof Array?b:a.toa(b),this.base_=null,this.generator_=function(a){throw new Error("infuse: attempted to request new elements for an array with no specified generator (this usually means that the array is backed by a real Javascript array and is therefore a read-only view)")}),this.version_=0},c.size=function(){return this.xs_.length},c.derivative=function(b){var c=a.fn.apply(this,arguments);return a.array(c,this)},c.force=function(a){for(var b=this.xs_,c=b.length,d=-1,e=function(a){b.push(a)};b.length>d&&(d=b.length)<a;)this.generator_(e);return d>c?this.touch():this},c.keys=function(){for(var b=[],c=0,d=this.size();c<d;++c)b.push(c);return a.array(b)},c.values=function(){return this},c.each=function(){this.pull();var b=a.fn.apply(this,arguments);for(var c=this.xs_,d=0,e=c.length;d<e;++d)if(b(c[d],d)===!1)break;return this},c.cursor=function(){var a=0,b=this.pull();return function(c){for(var d=b.xs_,e=d.length;a<e;++a)if(c(d[a],a)===!1)break}},c.get=function(b,c){var d=this.pull().xs_;if(b===void 0)return d;if(typeof b=="number"||b instanceof Number){if(b===b>>0)return d[b<0?d.length+b:b];var e=arguments.length>1?a.fnarg(arguments,1):function(a,b,c){return a+(b-a)*c},f=(b<0?d.length:0)+Math.floor(b),g=f+1,h=b-f;return e(d[f],d[g],h)}if(b instanceof Array){for(var i=[],j=0,k=d.length;j<k;++j)i.push(this.get(d[j]));return i}return a.fn.apply(this,arguments)(this)},c.first=function(b){var c=this.get();if(b===void 0)return c[0];if(typeof b=="number"||b instanceof Number)return a.array(c.slice(0,b<0?c.length+b:b));var d=a.fn.apply(this,arguments);for(var e=0,f=c.length;e<f;++e)if(d(c[e],e))return c[e];return null},c.last=function(b){var c=this.get(),d=c.length;if(b===void 0)return c[d-1];if(typeof b=="number"||b instanceof Number)return a.array(b===0?c:c.slice(b<0?d+b:b));var e=a.fn.apply(this,arguments);for(var f=d-1;f>=0;++f)if(e(c[f],f))return c[f];return null}}),a.alternatives.push({accepts:function(a){return a instanceof Array},construct:function(b){return a.array(b)}})}),infuse.extend(function(a){a.type("object",function(b,c){c.initialize=function(b,c){b instanceof Function?(this.o_={},this.base_=a.assert(c,"infuse: attempted to construct a lazy object without specifying a base object"),this.versions_={},this.generator_=b):(this.o_=b,this.base_=null,this.versions_=null,this.generator_=function(a){throw new Error("infuse: attempted to request new elements for an object with no specified generator (this usually means that the object is backed by a real Javascript object and is therefore a read-only view)")}),this.version_=0},c.size=function(){return this.keys().size()},c.derivative=function(b){var c=a.fn.apply(this,arguments);return a.object(c,this)},c.force=function(a){for(var b=this.o_,c=!0,d=!1,e=function(d,e){--a,c=!0,b[e]=d};a>0&&c;d=d||c,c=!1)this.generator_(e);return d?this.touch():this},c.touch=function(){return++this.version_,this},c.push=function(a,b){return this.o_[b]=a,this.versions_[b]=++this.version_,this}});var b=Object.prototype.toString.call({});a.alternatives.push({accepts:function(a){return Object.prototype.toString.call(a)===b},construct:function(b){return a.object(b)}})}),infuse.extend(function(a,b){b.touch=function(){return++this.version_,this},b.pull=function(){var a=this.base(),b=a&&a.pull().version();return b&&b>this.version_&&(this.force(a.size()).version_=b),this},b.map=function(b){var c=a.fn.apply(this,arguments),d=this.cursor();return this.derivative(function(a){d(function(b,d){a(c(b,d),d)})})},b.flatmap=function(b){var c=a.fn.apply(this,arguments),d=this.cursor();return this.derivative(function(b){d(function(d,e){a(c(d,e)).each(b)})})},b.filter=function(b){var c=a.fn.apply(this,arguments),d=this.cursor();return this.derivative(function(a){d(function(b,d){c(b,d)&&a(b,d)})})},b.mapfilter=function(b){var c=a.fn.apply(this,arguments),d=this.cursor();return this.derivative(function(a){d(function(b,d){var e=c(b,d);e&&a(e,d)})})},b.reductions=function(b,c){var d=a.fn.apply(this,Array.prototype.slice.call(arguments,1)),e=this.cursor();return this.derivative(function(a){e(function(c,e){a(b=d(b,c,e),e)})})},b.reduce=function(b,c){var d=a.fn.apply(this,Array.prototype.slice.call(arguments,1));return this.each(function(a,c){b=d(b,a,c)}),b},b.index=function(b){var c=a.fn.apply(this,arguments),d=this.cursor();return a.object(function(a){d(function(b,d){a(b,c(b,d))})})},b.group=function(b){var c=a.fn.apply(this,arguments),d=this.cursor();return a.multi_object(function(a){d(function(b,d){a(b,c(b,d))})})}});