(function(){var a=typeof infuse!=typeof void 0?infuse:undefined,b=typeof $i!=typeof void 0?$i:undefined,c=function(a){var b=function(c){for(var d=b.alternatives,e=d.length-1,f;e>=0;--e)if((f=d[e]).accepts.apply(f,arguments))return f.construct.apply(f,arguments);throw new Error(a+"("+Array.prototype.slice.call(arguments).join(", ")+") is not supported (no alternative accepted the supplied "+"arguments)")};return b.alternatives=[],b.accepts=function(a){for(var c=b.alternatives,d=c.length-1,e;d>=0;--d)if((e=c[d]).accepts.apply(e,arguments))return!0;return!1},b},d=c("infuse");d.dispatcher=c,d.hide=function(c){return $i===d&&($i=b,b=null),c&&infuse===d&&(infuse=a,a=null),d},$i=infuse=d})(),function(a){a.extend=function(b){return b.call(a,a,a.prototype)||a}}(infuse),infuse.extend(function(a){var b={};a.alternatives.push({accepts:function(a){return a===b},construct:function(){}}),a.type=function(c,d){var e=a[c]=function(){if(this.constructor!==e){var a=new e;return a.initialize.apply(a,arguments),a}};return(e.prototype=new a(b)).constructor=e,d.call(e,e,e.prototype)||e},a.mixins={},a.mixin=function(b,c){var d={};return c.call(d,d),a.mixins[b]=function(a){for(var b in d)Object.prototype.hasOwnProperty.call(d,b)&&(a[b]=d[b]);return a}},a.alternatives.push({accepts:function(b){return b instanceof a},construct:function(a){return a}})}),infuse.extend(function(a){a.identity=function(a){return a},a.id=a.identity,a.always=function(a){return function(){return a}},a.constantly=a.always,a.k=a.always,a.tap=function(b,c){return a.fnarg(arguments,1)(b),b},a.comparator_to_ordering=function(a){return function(b,c){return a(b,c)<0}},a.comparator_from_ordering=function(a){return function(b,c){return a(b,c)?-1:1}};var b=0;a.gen_id=function(){return"infuse-"+ ++b},a.toa=function(a){return Array.prototype.slice.call(a)},a.slice=function(a,b){return Array.prototype.slice.call(a,b)},a.fnarg=function(b,c){return a.fn.apply(this,a.slice(b,c))},a.assert=function(a,b){if(!a)throw new Error(b);return a},a.assert_equal=function(b,c){return a.assert(b===c,b+" != "+c),b}}),infuse.extend(function(a){a.mixin("pull",function(b){b.version=function(){return this.version_},b.is_derivative=function(){return!!this.generator_},b.pull=function(){var a=this.generator_,b=a&&a.version();return b&&b>this.version_&&(++this.version_,a.into(this)!==!1&&(this.version_=b)),this},b.push=function(a,b){return++this.version_,this.push_pair(a,b),this},b.into=function(a){},b.generator=function(){return a.pull_generator(this)},b.detach=function(){return this.generator_&&this.generator_.detach_derivative(this),this.generator_=null,this}})}),infuse.extend(function(a){a.type("pull_generator",function(b,c){a.mixins.pull(c),c.initialize=function(a){this.generator_=a,this.state_=a.generator_state(),this.target_=null},c.version=function(){return this.generator_.version()},c.tos=function(){return"#<"+this.generator_+">"},c.push_pair=function(b,c){return a.assert(this.target_!=null,"infuse: attempted to push a pair to a disconnected pull-generator (this sometimes means that you created a derivative collection that you never ended up using, or that you somehow connected a pull-generator to an asynchronous source)"),this.target_.push_pair(b,c)},c.generator=function(){return this},c.generator_state=function(){return this.state_},c.generate=function(b,c){a.assert(this.target_==null,"infuse: attempted to make a re-entrant call to a generator (this can happen if you have a circular generator transformation topology and no intermediate buffering collections)"),this.target_=b;var d=this.generator_.generate(b,c);return this.target_=null,d},c.derivative=function(b){return a.pull_generator(b)}})}),infuse.extend(function(a){a.type("aatree",function(b,c){a.mixins.pull(c),c.initialize=function(b,c){this.lt_=b?a.fn(b):function(a,b){return a<b},this.root_=null,this.size_=0,this.version_=-1,this.generator_=c,this.first_=null,this.last_=null,this.pull()},c.tos=function(){return(this.generator_?"#t<":"#<")+this.map('_2 + ": " + _1').join(", ")+">"},c.internal_tos=function(){return this.internal_tos_(this.root_)},c.internal_tos_=function(a){return a?a.k+"."+a.level+" ["+this.internal_tos_(a.l)+"]"+" ["+this.internal_tos_(a.r)+"]":""},c.aatree_node_=function(a,b,c,d,e){this.v=a,this.k=b,this.level=c,this.l=d,this.r=e},c.skew_=function(a){if(!a)return a;var b=a.l;return b&&b.level===a.level?(a.l=b.r,b.r=a,b):a},c.split_=function(a){if(!a)return a;var b=a.r,c=b&&b.r;return c&&a.level===c.level?(a.r=b.l,b.l=a,++b.level,b):a},c.insert_=function(a,b,d){return a==null?new c.aatree_node_(b,d,1,null,null):(this.lt_(d,a.k)?a.l=this.insert_(a.l,b,d):a.r=this.insert_(a.r,b,d),this.split_(this.skew_(a)))},c.remove_=function(a,b){if(!a||!a.l&&!a.r)return null;if(this.lt_(b,a.k))a.l=this.remove_(a.l,b);else if(b!==a.k)a.r=this.remove_(a.r,b);else if(!a.l){for(var c=a.r;c.l;c=c.l);a.r=this.remove_(a.r,c.k),a.k=c.k,a.v=c.v}else{for(var d=a.l;d.r;d=d.r);a.l=this.remove_(a.l,d.k),a.k=d.k,a.v=d.v}var e=1+Math.min(a.l?a.l.level:0,a.r?a.r.level:0);e<a.level&&(a.level=e,a.r&&e<a.r.level&&(a.r.level=e));if(a=this.skew_(a))if(a.r=this.skew_(a.r))a.r.r=this.skew_(a.r.r);if(a=this.split_(a))a.r=this.split_(a.r);return a},c.search_=function(a,b){if(!a)return null;var c=a.k;return b===c?a:this.lt_(b,c)?this.search_(a.l,b):this.search_(a.r,b)},c.traverse_=function(a,b,c){if(!a)return;var d=a.k;if(b===void 0||this.lt_(b,d)){this.traverse_(a.l,b,c);if(c.push(a.v,d)===!1)return!1}this.traverse_(a.r,b,c)},c.push_pair=function(a,b){return this.root_=this.insert_(this.root_,a,b),this.first_=this.last_=null,this},c.remove=function(a){return this.root_=this.remove_(this.root_,a),this.first_=this.last_=null,this},c.lookup=function(a){var b=this.search_(this.root_,a);return b&&b.v},c.first_node_=function(){if(!this.root_)return null;var a=this.first_;if(a==null){for(a=this.root_;a.l;a=a.l);this.first_=a}return a},c.first=function(){var a=this.first_node_();return a&&a.v},c.kfirst=function(){var a=this.first_node_();return a&&a.k},c.last_node_=function(){if(!this.root_)return null;var a=this.last_;if(a==null){for(a=this.root_;a.r;a=a.r);this.last_=a}return a},c.last=function(){var a=this.last_node_();return a&&a.v},c.klast=function(){var a=this.last_node_();return a&&a.k},c.derivative=function(b){var c=a.fn(b);return a.aatree(this.lt_,c)},c.generator_state=function(){return{last:void 0}},c.generate=function(a,b){return this.root_&&this.root_.traverse(function(c,d){if(a.push_pair(c,d)===!1)return!1;b.last=d})}})});