(function(){var a=typeof infuse!=typeof void 0?infuse:undefined,b=function(a){var b=function(c){for(var d=b.alternatives,e=d.length-1,f;e>=0;--e)if((f=d[e]).accepts.apply(f,arguments))return f.construct.apply(f,arguments);throw new Error(a+"("+Array.prototype.slice.call(arguments).join(", ")+") is not supported (no alternative accepted the supplied "+"arguments)")};return b.alternatives=[],b.accepts=function(a){for(var c=b.alternatives,d=c.length-1,e;d>=0;--d)if((e=c[d]).accepts.apply(e,arguments))return!0;return!1},b},c=b("infuse");c.dispatcher=b,c.hide=function(){return infuse=a,a=null,delete c.hide,c},c.unloaders=[],c.unload=function(){for(var a=c.unloaders,b=0,d=a.length;b<d;++b)a[b]()},infuse=c})(),function(a){a.extend=function(b){return b.call(a,a,a.prototype)||a}}(infuse),infuse.extend(function(a){var b={};a.alternatives.push({accepts:function(a){return a===b},construct:function(){}}),a.type=function(c,d){var e=a[c]=function(){if(this.constructor!==e){var a=new e;return a.initialize.apply(a,arguments),a}};return(e.prototype=new a(b)).constructor=e,d.call(e,e,e.prototype)||e},a.mixins={},a.mixin=function(b,c){var d={};return c.call(d,d),a.mixins[b]=function(a){for(var b in d)Object.prototype.hasOwnProperty.call(d,b)&&(a[b]=d[b]);return a}},a.alternatives.push({accepts:function(b){return b instanceof a},construct:function(a){return a}})}),infuse.extend(function(a){a.mixin("pull",function(b){b.base=function(){return this.base_},b.version=function(){return this.version_},b.pull=function(){var a=this.base_,b=a&&a.pull().version();if(b&&b>this.version_){++this.version_;var c=this;this.generator_(function(a,b){c.push_(a,b)},this.id()),this.version_=b}return this},b.push=function(b,c){return a.assert(!this.base_,"infuse: attempted to push onto a derivative"),++this.version_,this.push_(b,c)},b.detach=function(){return this.base_&&this.base_.detach_derivative(this),this.base_=this.generator_=null,this},b.detach_derivative=function(a){return this}})}),infuse.extend(function(a){a.mixin("push",function(a){a.pull=function(){return this},a.version=function(){return this.size()+1},a.detach=function(a){if(a)a.detach_derivative(this),delete this.bases_[a.id()];else{var b=this.bases_;for(var c in b)Object.prototype.hasOwnProperty.call(b,c)&&(b[c].detach_derivative(this),delete b[c])}return this},a.detach_derivative=function(a){var b=this.listeners_;return b&&delete b[a.id()],this}})}),infuse.extend(function(a){a.type("funnel",function(a,b){b.initialize=function(a){this.bases_=a},b.version=function(){for(var a=0,b=0,c=this.bases_,d=c.length;b<d;++b)a+=c[b].version();return a},b.pull=function(){return this},b.derivative=function(){throw new Error("infuse: funnels cannot produce derivatives")},b.generator=function(){var a=[],b=[],c=this;for(var d=0,e=this.bases_,f=e.length;d<f;++d)a.push(e[d].generator()),b.push(-1);return function(d,e){var f=0,g=c.bases_;if(g)for(var h=0,i=b.length;h<i;++h)(f=g[h].pull().version())>b[h]&&(b[h]=f,a[h](d,e))}},b.detach=function(){for(var a=0,b=this.bases_,c=b.length;a<c;++a)b[a].detach_derivative(this);return this.bases_=null,this},b.detach_derivative=function(a){return this}})}),infuse.extend(function(a){a.type("cell",function(b,c){a.mixins.pull(c),c.initialize=function(a,b){b?(this.x_=null,this.generator_=a,this.base_=b,this.version_=-1):(this.x_=a,this.generator_=null,this.base_=null,this.version_=1)},c.size=function(){return 1},c.push_=function(a,b){return this.x_=a,this},c.derivative=function(b,c){var d=a.fn(b);return a.cell(d,c||this)},c.generator=function(){var a=0,b=this;return function(c){a!==(a=b.version())&&c(b.x_,a)}},c.get=function(){return this.pull(),arguments.length?this.default_get.apply(this,arguments):this.x_}})}),infuse.extend(function(a){a.identity=function(a){return a},a.id=a.identity,a.always=function(a){return function(){return a}},a.constantly=a.always,a.k=a.always,a.tap=function(b,c){return a.fnarg(arguments,1)(b),b},a.immediate=function(b,c){return a.future().push(b,c)},a.await=function(b,c){var d=b===(b=a(b)),c=a.keygate(c),e=a.immediate(b.zero()),f=b.reduce(e,function(b,d,e){return d instanceof a.future||d instanceof a.signal?b.flatmap(function(a){return d.once(c).map(function(b){return a.push(b,e)})}):b.map(function(a){return a.push(d,e)})});return f.map(function(a){return d?a:a.get()})},a.progress=function(b,c){var d=b===(b=a(b)),c=a.keygate(c),e=a.signal().push(b.zero()),f=b.reduce(e,function(b,c,d){var e=c instanceof a.future||c instanceof a.signal?c:a.immediate(c);return e.generator()(function(a,c){b.push(b.get().push(a,d))},b.id()),b});return f.map(function(a){return d?a:a.get()})},a.on=function(b,c,d){return b instanceof a.future||b instanceof a.signal?b.once(c,d):d(b)},a.comparator_to_ordering=function(a){return function(b,c){return a(b,c)<0}},a.comparator_from_ordering=function(a){return function(b,c){return a(b,c)?-1:1}};var b=0;a.gen_id=function(){return"infuse-"+ ++b},a.toa=function(a){return Array.prototype.slice.call(a)},a.slice=function(a,b){return Array.prototype.slice.call(a,b)},a.fnarg=function(b,c){return a.fn.apply(this,a.slice(b,c))},a.assert=function(a,b){if(!a)throw new Error(b);return a},a.assert_equal=function(b,c){return a.assert(b===c,b+" != "+c),b},a.msb=function(a){for(var b=0,c=64;b+1<c;){var d=b+c>>>1,e=a>>>d;e&&e!==a?b=d:c=d}return b}}),infuse.extend(function(a){a.type("heapmap",function(b,c){a.mixins.pull(c),c.initialize=function(b,c,d){this.above_=b?a.fn.apply(this,arguments):function(a,b){return a<b},this.xs_=[null],this.keys_=[null],this.map_={},this.version_=-1,this.base_=d,this.generator_=c,a.assert(!!d==!!c,"infuse: base and generator must be specified together (error constructing heapmap)")},c.size=function(){return this.pull().xs_.length-1},c.derivative=function(b,c){var d=a.fn.apply(this,arguments);return a.heapmap(this.above_,d,c||this)},c.generator=function(){var b=this,c=null,d=!1;return function(e,f){var g=b.pull().xs_,h=b.keys_,i=g.length;if(i<=1)return;var j=a.msb(i-1),k=d?b.initial_ceiling_(c,j):1;if(k===null)return;var l=a.heapmap(b.above_),m=b.version_;for(var n=k,o;n!==null;n=b.next_ceiling_(c,n,j))l.push(o=g[n],n);while(l.size()){var n=+l.pop(),o=g[n];c=o,d=!0;if(e(c=g[n],h[n])===!1)return;var p=n<<1;if(p<i){l.push(g[p],p);var q=p+1;q<i&&l.push(g[q],q)}}}},c.next_ceiling_=function(b,c,d){if(!(c&c+1))return null;var e=this.xs_,f=e.length;if(c+1>=f&&!((c>>>=1)&c+1))return null;var g=c&1;++c;if(this.above_(b,e[c]))return g?this.topmost_ceiling_(b,c,d):c;for(c<<=d-a.msb(c);c&c-1&&c<f;++c)if(this.above_(b,e[c]))return this.topmost_ceiling_(b,c,d);for(c>>>=1,f=1<<d;c<f;++c)if(this.above_(b,e[c]))return this.topmost_ceiling_(b,c,d);return null},c.topmost_ceiling_=function(a,b,c){var d=this.xs_;for(var e=0,f=c;e+1<f;){var g=e+f>>>1;this.above_(a,d[b>>>g])?e=g:f=g}return b>>>e},c.initial_ceiling_=function(a,b){var c=this.xs_;for(var d=1<<b,e=d,f=c.length;d<f;++d)if(this.above_(a,c[d]))return this.topmost_ceiling_(a,d,b);for(d>>>=1;d<e;++d)if(this.above_(a,c[d]))return this.topmost_ceiling_(a,d,b);return null},c.get=function(a){var b=this.map_;return typeof a=="string"||a instanceof String?this.xs_[b[a]]:this.get_default.apply(this,arguments)},c.remove=function(b){a.assert(!this.base_,"infuse: attempted to remove() from a derivative heapmap (because the heap map is a derivative, modifying it directly is illegal)");var c=this.xs_,d=this.map_,e=this.keys_;return c.length<=1?void 0:(c.length>2?(c[1]=c.pop(),e[1]=e.pop()):(c.pop(),e.pop()),c.length>1&&(d[e[1]]=1,this.heapify_down_(1)),delete d[b],++this.version_,this)},c.pop=function(){var a=this.keys_;if(a.length<=1)return void 0;var b=a[1];return this.remove(b),b},c.peek=function(){return this.keys_[1]},c.push_=function(a,b){var c=this.xs_,d=this.keys_,e=this.map_;if(Object.prototype.hasOwnProperty.call(e,b)){var f=e[b],g=c[f];return c[f]=a,this.above_(a,g)?this.heapify_up_(f):this.heapify_down_(f)}var h=c.length;return c.push(a),d.push(b),this.heapify_up_(e[b]=h)},c.swap_=function(a,b){var c=this.xs_,d=this.keys_,e=this.map_,f=c[a];return c[a]=c[b],c[b]=f,f=d[a],d[a]=d[b],d[b]=f,e[d[a]]=a,e[d[b]]=b,this},c.heapify_down_=function(a){var b=this.xs_,c=b.length;if(a<<1>=c)return this;var d=a<<1,e=d|1,f=b[a],g=b[d],h=b[e];if(this.above_(f,g)&&(e>=c||this.above_(f,h)))return this;var i=e>=c||this.above_(g,h)?d:e;return this.swap_(a,i).heapify_down_(i)},c.heapify_up_=function(a){var b=this.xs_,c=a>>>1;return c&&this.above_(b[a],b[c])?this.swap_(a,c).heapify_up_(c):this}})}),infuse.extend(function(a){a.cache=function(b){var c={},d={};b=b||a.cache.lru();var e=function(a,f){return b(e,c,d,a,f)};return e(null,null),e},a.cache.lru=function(b){b=b||{};var c=b.capacity||1e3,d=function(a,b){return b.size?(--b.size,delete a[b.priority_queue.pop()]):!1},e=function(a,b){for(var c in a)delete a[c];while(b.priority_queue.size())b.priority_queue.pop();b.size=0};return function(b,f,g,h,i){if(h===null&&i===null)return g.size=0,g.access_counter=0,g.priority_queue=a.heapmap(),b.hits=0,b.evictions=0,b.misses=0,b.evict_one=function(){return d(f,g)},b.clear=function(){return e(f,g)},null;h="@"+h;if(Object.prototype.hasOwnProperty.call(f,h))return++b.hits,g.priority_queue.push(++g.access_counter,h),f[h];var j=i(h);return++b.misses,++g.size>c&&(++b.evictions,d(f,g)),g.priority_queue.push(++g.access_counter,h),f[h]=j}}}),infuse.extend(function(a){a.fn=a.dispatcher("infuse.fn"),a.fn.cache=a.cache(a.cache.lru({capacity:2048})),a.fn.auto_gc=function(){a.fn.cache_interval=setInterval(a.fn.cache.evict_one,1e3),a.unloaders.push(function(){clearInterval(a.fn.cache_interval)})},a.fn.alternatives.push({accepts:function(a){return!0},construct:function(b){var c=a.apply(this,arguments);return c.fn.apply(c,a.slice(arguments,1))}}),a.fn.alternatives.push({accepts:function(a){return a&&a.fn instanceof Function},construct:function(b){return b.fn.apply(b,a.slice(arguments,1))}}),a.fn.alternatives.push({accepts:function(a){return a.constructor===RegExp},construct:function(b){return a.fn.regexp_group_count(b)?function(a){var c=b.exec(a);return c&&Array.prototype.slice.call(c,1)}:function(a){var c=b.exec(a);return c&&c[0]}}}),a.fn.regexp_group_count=function(a){for(var b=a.toString(),c=0,d=-1,e=b.lastIndexOf("/"),f=!1,g=1,h=!1,i;g<e;++g)i=b.charCodeAt(g),f?f=!1:i===92?f=!0:i===93?h=!1:h||(i===91?h=!0:i===40?(d=g+1,++c):g===d&&i===63&&--c);return c},a.fn.is_path=function(a){return/^\./.test(a)},a.fn.is_js=function(a){return/^[-+\/~!$\w([{'"]/.test(a)},a.fn.alternatives.push({accepts:function(b){return b.constructor===String&&a.fn.is_path(b)},construct:function(b){return a.fn.cache(b,function(){var c=a.inversion.parse_path(b);return function(b){return a.inversion.at(c,b)}})}}),a.fn.alternatives.push({accepts:function(b){return b.constructor===String&&a.fn.is_js(b)},construct:function(b,c){return a.fn.cache(a.fn.binding_prefix(c)+b,function(){return a.fn.compile(b,c)})(c)}}),a.fn.binding_prefix=function(a){if(!a)return"";var a=[];for(var b in a)Object.prototype.hasOwnProperty.call(a,b)&&a.push(b);return a.sort().join(",")+":"},a.fn.body_arity=function(a){for(var b=a.match(/_\d?/g)||[],c=0,d=b.length,e=+!!b.length;c<d;++c)e=Math.max(e,+b[c].substr(1));return e},a.fn.compile=function(b,c){var d=[],e=[];for(var f in c)Object.prototype.hasOwnProperty.call(c,f)&&d.push("var "+f+" = _."+f+";\n");for(var g=0,h=a.fn.body_arity(b);g<h;++g)e.push("_"+(g+1));return new Function("_",d+"return function ("+e.join(", ")+") {\n"+(e.length?"var _ = _1;\n":"")+"return "+b+";\n"+"};")},a.fn.alternatives.push({accepts:function(a){return a instanceof Function},construct:function(a){return a}}),a.fn.alternatives.push({accepts:function(a){return a==null},construct:function(a){return function(a){return a}}})}),infuse.extend(function(a){a.keygate=a.dispatcher("infuse.keygate"),a.keygate.cache=a.cache(a.cache.lru({capacity:2048})),a.keygate.alternatives.push({accepts:function(){return!0},construct:function(){return a.fn.apply(this,arguments)}}),a.keygate.words=function(a){return function(b){return b==null||a.indexOf(b)>-1}},a.keygate.alternatives.push({accepts:function(a){return typeof a=="string"||a instanceof String},construct:function(b){return a.keygate.cache(b,function(){return a.keygate.words(b.split(/\s+/))})}}),a.keygate.alternatives.push({accepts:function(a){return a==null},construct:function(){return function(){return!0}}}),a.keygate.alternatives.push({accepts:function(a){return a===!1},construct:function(){return function(){return!1}}})}),infuse.extend(function(a){a.type("array",function(b,c){a.mixins.pull(c),c.initialize=function(b,c){b instanceof Function?(this.xs_=[],this.base_=c,this.generator_=b,this.version_=-1,this.pull()):(this.xs_=b instanceof Array?b:a.toa(b),this.base_=null,this.generator_=null,this.version_=1)},c.size=function(){return this.pull().xs_.length},c.push_=function(a,b){return this.xs_.push(a),this},c.derivative=function(b,c){var d=a.fn(b);return a.array(d,c||this)},c.generator=function(){var a=0,b=this;return function(c){for(var d=b.pull().xs_,e=d.length;a<e;)if(c(d[a],a++)===!1)return!1}},c.get=function(b,c){var d=this.pull().xs_;if(b===void 0)return d;if(typeof b=="number"||b instanceof Number){if(b===b>>0)return d[b<0?d.length+b:b];var e=arguments.length>1?a.fnarg(arguments,1):function(a,b,c){return a+(b-a)*c},f=(b<0?d.length:0)+Math.floor(b),g=f+1,h=b-f;return e(d[f],d[g],h)}return this.get_default.apply(this,arguments)},c.first=function(b){var c=this.get();if(b===void 0)return c[0];if(typeof b=="number"||b instanceof Number)return a.array(c.slice(0,b<0?c.length+b:b));var d=a.fn.apply(this,arguments);for(var e=0,f=c.length;e<f;++e)if(d(c[e],e))return c[e];return null},c.last=function(b){var c=this.get(),d=c.length;if(b===void 0)return c[d-1];if(typeof b=="number"||b instanceof Number)return a.array(b===0?c:c.slice(b<0?d+b:b));var e=a.fn.apply(this,arguments);for(var f=d-1;f>=0;++f)if(e(c[f],f))return c[f];return null}}),a.alternatives.push({accepts:function(a){return a instanceof Array},construct:function(b){return a.array(b)}})}),infuse.extend(function(a){a.type("tail",function(b,c){a.mixins.pull(c),c.initialize=function(a,b,c){this.xs_=[],this.size_=a,this.zero_=0,this.base_=c,this.generator_=b,this.version_=-1,this.pull()},c.size=function(){return this.pull().xs_.length},c.push_=function(a,b){var c=this.zero_++;return this.xs_[c%this.size_]=a,this},c.derivative=function(b){var c=a.fn.apply(this,arguments);return a.tail(this.size_,c,this)},c.generator=function(){var a=0,b=this;return function(c){var d=b.zero_,e=b.pull().xs_,f=e.length;a=Math.max(a,d-f);for(;a<d;)if(c(e[a%f],a++)===!1)return!1}},c.get=function(b,c){var d=this.pull().xs_,e=d.length,f=this.zero_;if(b===void 0)return d.slice(f%e).concat(d.slice(0,f%e));if(typeof b=="number"||b instanceof Number){if(b===b>>0)return d[(b+e+f)%e];var g=arguments.length>1?a.fnarg(arguments,1):function(a,b,c){return a+(b-a)*c},h=Math.floor(b+e+f)%e,i=(h+1)%e,j=b-h;return g(d[h],d[i],j)}return this.get_default.apply(this,arguments)}})}),infuse.extend(function(a){a.type("object",function(b,c){a.mixins.pull(c),c.initialize=function(b,c){b instanceof Function?(this.o_={},this.base_=a.assert(c,"infuse: attempted to construct a derivative object without specifying a base"),this.generator_=b,this.version_=-1,this.journal_=a.heapmap(),this.pull()):(this.o_=b,this.base_=null,this.generator_=null,this.version_=1,this.journal_=null)},c.size=function(){return this.pull().journal().size()},c.push_=function(a,b){var c=this.o_;return c[b]=a,this.journal().push(this.version_,b),this},c.derivative=function(b,c){var d=a.fn.apply(this,arguments);return a.object(d,c||this)},c.journal=function(){var b=this.journal_;if(!b){var c=this.o_,d=this.version_;b=this.journal_=a.heapmap();for(var e in c)Object.prototype.hasOwnProperty.call(c,e)&&b.push(d,e)}return b},c.generator=function(){var a=this.journal().generator(),b=this.o_;return function(c){return a(function(a,d){return c(b[d],d)})}},c.get=function(a){var b=this.pull().o_;return a===void 0?b:typeof a=="string"||a instanceof String?b[a]:this.get_default.apply(this,arguments)}});var b=Object.prototype.toString.call({});a.alternatives.push({accepts:function(c){return Object.prototype.toString.call(c)===b&&!(c instanceof a)},construct:function(b){return a.object(b)}})}),infuse.extend(function(a){a.type("multiobject",function(b,c){a.mixins.pull(c),c.initialize=function(b,c){this.o_={},this.size_=0,this.journal_=a.heapmap();if(b instanceof Function)this.version_=-1,this.generator_=b,this.base_=a.assert(c,"infuse: attempted to create a derivative multiobject without specifying a base"),this.pull();else{this.version_=0,this.generator_=null,this.base_=null;if(b)for(var d in b)Object.prototype.hasOwnProperty.call(b,d)&&this.push(b[d],d)}},c.size=function(){return this.pull().size_},c.push_=function(b,c){var d=this.o_;return Object.prototype.hasOwnProperty.call(d,c)?d[c].push(b):d[c]=a.array([b]),this.journal().push(this.version_,c),++this.size_,this},c.derivative=function(b,c){var d=a.fn.apply(this,arguments);return a.multiobject(d,c||this)},c.generator=function(){var a=this.journal().generator(),b={},c=this.o_;return function(d,e){return a(function(a,f){Object.prototype.hasOwnProperty.call(b,f)||(b[f]=c[f].generator()),b[f](function(a){return d(a,f)},e)})}},c.get=function(a){var b=this.pull().o_;return a===void 0?b:typeof a=="string"||a instanceof String?b[a]:this.get_default.apply(this,arguments)}})}),infuse.extend(function(a){a.type("future",function(b,c){a.mixins.push(c),c.initialize=function(b,c){this.listeners_={},this.bases_={},this.value_=null,this.key_=null,this.generator_=null;if(b){a.assert(c,"infuse: attempted to construct a derivative future without specifying a base");var d=this;b(function(a,b){return d.push(a,b)},this.id()),this.bases_[c.id()]=c}},c.size=function(){return+!this.listeners_},c.key=function(){return this.key_},c.derivative=function(b,c){var d=a.fn.apply(this,arguments);return a.future(d,c||this)},c.generator=function(){var b=this.generator_;if(!b){var c=this;b=this.generator_=function(b,d){var e=c.listeners_;if(!e)return b(c.value_,c.key_);e[d||a.gen_id()]=b}}return b},c.push=function(b,c){a.assert(this.listeners_,"infuse: attempted to push to an already-decided future");var d=this.listeners_;for(var e in d)Object.prototype.hasOwnProperty.call(d,e)&&d[e](b,c);return this.detach(),this.listeners_=null,this.value_=b,this.key_=c,this},c.get=function(a){return a===void 0?this.value_:typeof a=="string"||a instanceof String?a===this.key_?this.value_:null:this.get_default.apply(this,arguments)},c.on=function(b,c,d){b=a.keygate(b);if(!c){var e=this.generator();return a.signal(function(a,c){e(function(c,d){if(b(d))return a(c,d)},c)},this)}return this.generator()(function(a,d){b(d)&&c(a,d)},d||a.gen_id()),this},c.once=function(b,c,d){b=a.keygate(b);if(!c){var e=this.generator();return this.derivative(function(a,c){e(function(c,d){if(b(d))return a(c,d)},c)})}return this.on(b,c,d)},c.trigger=function(a){var b=this;return function(c){b.push(c,a)}}})}),infuse.extend(function(a){a.type("signal",function(b,c){a.mixins.push(c),c.initialize=function(b,c){this.listeners_={},this.bases_={},this.value_=null,this.key_=null,this.generator_=null,this.size_=0;if(b){a.assert(c,"infuse: attempted to construct a derivative signal without specifying a base");var d=this;b(function(a,b){return d.push(a,b)},this.id()),this.bases_[c.id()]=c}},c.size=function(){return this.size_},c.key=function(){return this.key_},c.derivative=function(b,c){var d=a.fn.apply(this,arguments);return a.signal(d,c||this)},c.generator=function(){var b=this.generator_;if(!b){var c=this;b=this.generator_=function(b,d){a.assert(d!=null,"infuse: attempted to construct a push generator without specifying an ID (this may cause space leaks, so it is disallowed)"),c.listeners_[d]=b}}return b},c.push=function(a,b){this.value_=a,this.key_=b,++this.size_;var c=this.listeners_;for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&c[d](a,b);return this},c.get=function(a){return a===void 0?this.value_:typeof a=="string"||a instanceof String?a===this.key_?this.value_:null:this.default_get.apply(this,arguments)},c.on=function(b,c,d){b=a.keygate(b);if(!c){var e=this.generator();return this.derivative(function(a,c){e(function(c,d){if(b(d))return a(c,d)},c)},this)}return this.generator()(function(a,d){b(d)&&c(a,d)},d||a.gen_id()),this},c.once=function(b,c,d){d=d||a.gen_id(),b=a.keygate(b);if(!c){var e=this.generator();return a.future(function(a,c){e(function(c,d){if(b(d))return a(c,d)},c)},this)}var f=this;return this.generator()(function(a,e){b(e)&&(delete f.listeners_[d],c(a,e))},d),this},c.trigger=function(a){var b=this;return function(c){b.push(c,a)}}})}),infuse.extend(function(a){a.type("edge",function(b,c){c.initialize=function(b,c,d,e){this.a_=b,this.b_=c,this.ga_=b.generator(),this.gb_=c.generator(),this.va_=b.version(),this.vb_=c.version(),this.sig_=a.signal(),this.gate_=a.signal(),this.keygate_=this.gate_.map(a.keygate),this.gate_.push(null),d=a.fn(d),e=a.fn(e);var f=this;this.from_a_=function(a,b){return f.push(d(a,b),b)},this.from_b_=function(a,b){return f.push(e(a,b),b)},this.ga_(this.from_a_,this.id()),this.gb_(this.from_b_,this.id())},c.size=function(){return this.sig_.size()},c.version=function(){return this.sig_.version()},c.keygate=function(a){return arguments.length?(this.gate_.push(a),this):this.keygate_.get()},c.gate=function(){return this.gate_},c.detach=function(){return this.a_.detach_derivative(this),this.b_.detach_derivative(this),this.a_=this.b_=null,this},c.detach_derivative=function(a){return this.sig_.detach_derivative(a),this},c.derivative=function(a,b){return this.sig_.derivative(a,b)},c.generator=function(){return this.sig_.generator()},c.push=function(b,c){var d=this.a_,e=this.b_;a.assert(d&&e,"infuse: cannot push to an edge with undefined endpoints (this happens if you call push() on an edge after detaching it)");if(!this.keygate_.get()(c))return this;var f=this;return a.on(b,null,function(a){var b=d.version(),g=e.version(),h=f.va_,i=f.vb_;h<b&&i>=g&&(f.sig_.push(a,c),e.push(a,c),f.gb_(f.from_b_,f.id()),f.vb_=i=e.version(),f.va_=h=b),i<g&&h>=b&&(f.sig_.push(a,c),d.push(a,c),f.ga_(f.from_a_,f.id()),f.va_=h=d.version(),f.vb_=i=g)}),this},c.is_divergent=function(){return this.a_.version()>this.va_&&this.b_.version()>this.vb_},c.choose=function(a,b){if(this.is_divergent()||b)if(a===this.a_||a===!0)this.vb_=this.b_.version();else{if(a!==this.b_&&a!==!1)throw new Error("infuse: attempted to choose() a nonexistent endpoint");this.va_=this.a_.version()}return this},c.pull=function(){return this.va_<this.a_.pull().version()&&this.ga_(this.from_a_,this.id()),this.vb_<this.b_.pull().version()&&this.gb_(this.from_b_,this.id()),this}})}),infuse.extend(function(a,b){b.tap=function(b){return a.fn.apply(this,arguments)(this),this},b.id=function(){var b=this.id_;return b||(b=this.id_=a.gen_id()),b},b.keys=function(){var b=this.generator();return a.array(function(a,c){b(function(b,c){return a(c,c)},c)},this)},b.values=function(){var b=this.generator();return a.array(b,this)},b.inverse=function(){var a=this.generator();return this.derivative(function(b,c){a(function(a,c){return b(c,a)},c)})},b.into=function(b){if(typeof b==typeof a){var c=a.slice(arguments,1);return c.push(this.generator()),c.push(this),b.apply(a,c)}return b instanceof a?(this.generator()(function(a,c){b.push(a,c)},b.id()),b):this.into(a.apply(this,arguments)).get()},b.fget=function(){var b=this.get.apply(this,arguments);while(b instanceof a)b=b.get();return b},b.pairs=function(){var b=this.generator();return a.array(function(a,c){b(function(b,c){return a([b,c])},c)},this)},b.unpair=function(b){var c=a(b).generator(),d=this;return c(function(a){d.push(a[0],a[1])},this.id()),this},b.plus=function(){var b=a.funnel([this].concat(a.toa(arguments)));return this.derivative(b.generator(),b)},b.zero=function(){return this.derivative(function(){},this).detach()},b.each=function(b){var c=a.fn.apply(this,arguments);return this.generator()(c),this},b.map=function(b){var c=a.fn.apply(this,arguments),d=this.generator();return this.derivative(function(a,b){d(function(b,d){return a(c(b,d),d)},b)})},b.kmap=function(b){var c=a.fn.apply(this,arguments),d=this.generator();return this.derivative(function(a,b){d(function(b,d){return a(b,c(d,b))},b)})},b.flatmap=function(b){var c=a.fn.apply(this,arguments),d=this.generator();return this.derivative(function(b,e){d(function(d,g){var h=c(d,g);return h&&a(h).generator()(b,e)},e)})},b.filter=function(b){var c=a.fn.apply(this,arguments),d=this.generator();return this.derivative(function(a,b){d(function(b,d){if(c(b,d))return a(b,d)},b)})},b.mapfilter=function(b){var c=a.fn.apply(this,arguments),d=this.generator();return this.derivative(function(a,b){d(function(b,d){var e=c(b,d);if(e)return a(e,d)},b)})},b.join=function(a){return this.values().get().join(a)},b.fn=function(){var b=this.map(function(b,c){return a.fn(b)});return function(){var a=this,c=arguments;return b.map(function(b,d){return b.apply(a,c)})}},b.get_default=function(b){if(a.accepts(b)){var c=this;return a.fn(a(b).map(function(a){return function(b){return b.get(a)}}))(this,this.id())}return a.fn.apply(this,arguments)(this,this.id())},b.sort=function(b){var c=b&&a.fn.apply(this,arguments),d=a.heapmap(c,this.generator(),this),e=d.generator(),f=this;return this.derivative(function(a,b){e(function(b,c){return a(f.get(c),c)},b)},d)},b.sortby=function(b){var c=a.fn.apply(this,arguments),d=this.generator(),e=a.heapmap(null,function(a,b){d(function(b,d){return a(c(b,d),d)},b)},this),f=e.generator(),g=this;return this.derivative(function(a,b){f(function(b,c){return a(g.get(c),c)},b)},e)},b.uniq=function(b){var c=b?a.fn.apply(this,arguments):function(a){return a},d=this.generator(),e={};return this.derivative(function(a,b){d(function(b,d){if(e!==(e=c(b)))return a(b,d)},b)})},b.reductions=function(b,c){var d=a.fnarg(arguments,1),e=this.generator();return this.derivative(function(a,c){e(function(c,e){return a(b=d(b,c,e),e)},c)})},b.reduction=function(b,c){var d=a.fnarg(arguments,1),e=this.generator();return a.cell(function(a,c){e(function(c,e){return a(b=d(b,c,e),e)},c)},this)},b.reduce=function(b,c){var d=a.fnarg(arguments,1);return this.each(function(a,c){b=d(b,a,c)}),b},b.index=function(b){var c=a.fn.apply(this,arguments),d=this.generator();return a.object(function(a,b){d(function(b,d){return a(b,c(b,d))},b)},this)},b.group=function(b){var c=a.fn.apply(this,arguments),d=this.generator();return a.multiobject(function(a,b){d(function(b,d){return a(b,c(b,d))},b)},this)},b.tail=function(b){var c=this.generator();return a.tail(b,c,this)},b.to=function(b,c,d){return a.edge(this,b,c,d)}});